pipeline{
  agent any
  tools {
    maven 'maven 3.9.6'
  }
  stages{
    stage('Clone from Github'){
      steps {
        echo 'Cloning from GitHub'
        git 'https://github.com/Maryspear/maven-web-app.git'
        echo 'cloning done'
      }
    }
    stage(' Predeployment'){ 
        steps{ 
        sh "echo Build docker image" 
        #removing all images:
        sh "docker rmi -f ${docker images -aq}"
        #removing all containers:
        sh "docker rm -f ${docker ps -aq}"
        //sh "docker rm -f tom"
        //sh "docker rm -f sona"
        //sh "docker rmi -f sonarqube:9.9.4-community"
        sh "docker build -t Dockerfile_sona ."
        sh "docker build -t Dockerfile_nex ."
        sh "docker build -t Dockerfile_tom ."
        //sh "docker push joveluro/maven-web-app:latest"
        sh "docker run --name sona -d -p 9000:9000 sonarqube:9.9.4-community"
        sh "docker run --name nex -d -p 8081:8081 sonatype/nexus3:3.67.1-java11"
        sh "docker run --name tom -d -p 8000:8080 tomcat:9.0.88-jdk8-corretto"
        } 
    }
    stage('Build with Maven'){
      steps{
        echo 'Building with Maven'
        sh 'mvn package'
        echo 'Building done'
      }
    }  
    stage('Test with Sonarqube'){
      steps{
        echo 'Testing started'
        sh 'mvn sonar:sonar'
        echo 'Test done'
      }
    }
    stage('Deploying to Nexus'){
      steps{
        echo 'Deploying to Nexus'
        sh 'mvn deploy'
        echo 'Deployment to Nexu successful'
      }
    }
    stage('Deploying to Tomcat'){
      steps{
        echo 'Deploying to Tomcat'
        deploy adapters: [tomcat9(credentialsId: 'Tomcat_credentials', path: '', url: 'http://3.84.168.180:7000/')], contextPath: null, war: 'target/*war'
        echo 'Deployment successful'
      }
    }
  }
}
